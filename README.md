# Attribute War - Multiplayer

Este reposit√≥rio cont√©m o desenvolvimento de um jogo de cartas online multiplayer. O projeto foca em duelos t√°ticos e cole√ß√£o de cartas, com toda a l√≥gica de jogo, estado dos jogadores e comunica√ß√£o gerenciada por um servidor centralizado.

A aplica√ß√£o cliente-servidor √© desenvolvida em Go e a comunica√ß√£o √© realizada via sockets TCP. O ambiente √© totalmente containerizado com Docker e Docker Compose para facilitar a execu√ß√£o, o teste e a implanta√ß√£o.

## Funcionalidades Principais

- **Servidor Centralizado**: Gerencia a l√≥gica do jogo, o estado dos jogadores e a comunica√ß√£o entre eles em tempo real.

- **Comunica√ß√£o via Sockets**: A comunica√ß√£o entre cliente e servidor √© bidirecional e implementada exclusivamente com a biblioteca nativa de sockets TCP, sem o uso de frameworks externos.

- **Partidas 1v1**: O sistema permite que m√∫ltiplos jogadores se conectem simultaneamente e os pareia em duelos √∫nicos, garantindo que um jogador n√£o enfrente v√°rios oponentes ao mesmo tempo.

- **Visualiza√ß√£o de Atraso**: Sistema implementado de PING/PONG que permite aos jogadores visualizar a lat√™ncia (RTT - Round-Trip Time) de sua comunica√ß√£o com o servidor quando solicitado atrav√©s do comando `/ping`, exibindo valores como `RTT: 3 ms` no console.

- **Sistema de Pacotes de Cartas**: Mec√¢nica completa de abertura de pacotes com estoque global thread-safe. O servidor gerencia atomicamente as requisi√ß√µes concorrentes, garantindo justi√ßa na distribui√ß√£o e auditoria completa de todas as transa√ß√µes. Cada pacote cont√©m 3 cartas √∫nicas sorteadas aleatoriamente.

- **Chat em Tempo Real**: Sistema de comunica√ß√£o entre jogadores baseado em salas, permitindo coordena√ß√£o e intera√ß√£o social durante as partidas.

- **Sistema de Comandos**: Interface completa de comandos no cliente incluindo `/ping` para lat√™ncia, `/pack` para abertura de pacotes, `/play` para jogadas, `/hand` para visualizar cartas, e `/help` para ajuda.

- **Ambiente Containerizado**: Todos os componentes s√£o desenvolvidos e testados em cont√™ineres Docker, permitindo a f√°cil execu√ß√£o e escalabilidade para testes.

## Tecnologias Utilizadas

- **Go**: Linguagem de programa√ß√£o para o desenvolvimento do cliente e do servidor.
- **Docker**: Para a cria√ß√£o das imagens dos cont√™ineres do cliente e do servidor.
- **Docker Compose**: Para orquestrar e gerenciar os cont√™ineres da aplica√ß√£o.

## Como Executar

Certifique-se de ter o Docker e o Docker Compose instalados em sua m√°quina.

1. **Clone o reposit√≥rio** (ou garanta que todos os arquivos estejam no mesmo diret√≥rio).

2. **Construa as imagens e inicie os cont√™ineres:**
   O comando a seguir ir√° construir as imagens, iniciar 1 cont√™iner para o servidor e 2 cont√™ineres para os clientes em modo "detached" (em segundo plano).

   ```bash
   docker compose up --build -d
   ```

## Testando a Aplica√ß√£o

Para interagir com a aplica√ß√£o, voc√™ pode se conectar a uma sess√£o interativa com cada um dos clientes. Para isso, voc√™ precisar√° de duas janelas de terminal.

1. **Liste os cont√™ineres em execu√ß√£o** para obter seus nomes:
   ```bash
   docker ps
   ```
   A sa√≠da mostrar√° os nomes dos cont√™ineres, como `pbl2-redes-client-1` e `pbl2-redes-client-2`.

2. **Abra dois terminais.**

3. **No primeiro terminal**, conecte-se ao primeiro cliente:
   ```bash
   docker attach pbl2-redes-client-1
   ```

4. **No segundo terminal**, conecte-se ao segundo cliente:
   ```bash
   docker run -it --rm --env SERVER_ADDR="host.docker.internal:9001" pingpong-client:latest
   ```

5. **Agora voc√™ pode**:
   - **Usar comandos**: Digite `/help` para ver todos os comandos dispon√≠veis
   - **Jogar partidas**: Digite qualquer mensagem para entrar na fila de matchmaking e jogar duelos 1v1
   - **Abrir pacotes**: Use `/pack` para abrir pacotes de cartas (estoque limitado e concorrente)
   - **Gerenciar cartas**: Use `/hand` para ver sua m√£o e `/play <n√∫mero>` para jogar cartas
   - **Monitorar a lat√™ncia**: Use `/ping` para ativar/desativar a exibi√ß√£o de RTT
   - **Testar concorr√™ncia**: Execute m√∫ltiplos clientes simultaneamente para testar o sistema de pacotes

### Exemplo de Sa√≠da do Cliente:
```
[CLIENT] Conectado ao servidor 172.20.0.2:9000
Digite mensagens ou comandos (/help para ajuda):

/help
=== AJUDA ===
  /play <idx> - Jogar carta pelo √≠ndice (1-5)
  /hand       - Mostrar sua m√£o atual
  /ping       - Liga/desliga exibi√ß√£o de RTT
  /pack       - Abrir pacote de cartas
  /help       - Mostrar esta ajuda
  /quit       - Sair do jogo

oi
üéÆ Partida encontrada! Oponente: 172.20.0.3:45678

=== RODADA 1 ===
üíö Seu HP: 20 | ‚ù§Ô∏è HP do Oponente: 20
üÉè Sua m√£o (5 cartas):
  [1] Fire Dragon - FIRE (ATK: 8 / DEF: 5)
  [2] Ice Mage - WATER (ATK: 6 / DEF: 6)
  ...

/pack
üì¶ Tentando abrir pacote...
üì¶ Pacote aberto! Cartas recebidas: [c_003, c_005, c_002]
üìä Estoque restante: 99 pacotes
```

> **Importante**: Para sair da sess√£o `attach` sem derrubar o cont√™iner, use a combina√ß√£o de teclas `Ctrl+P` e em seguida `Ctrl+Q`.

## Jogando em M√°quinas Diferentes (em Rede)

Para jogar com um amigo em outra m√°quina, uma m√°quina atuar√° como o servidor e a outra se conectar√° a ela atrav√©s do seu endere√ßo de IP na rede.

**IPs de Exemplo:**

  * **M√°quina Principal (Servidor):** `172.16.201.14`
  * **M√°quina Secund√°ria (Cliente):** `172.16.201.15`

### Passo 1: Iniciar o Servidor na M√°quina Principal

Nesta m√°quina, vamos iniciar o servidor e apenas um cliente local, que ficar√° esperando por um oponente.

```bash
# No terminal da M√°quina Principal (172.16.201.14)
docker compose up --build --scale client=1 -d
```

  * O servidor estar√° rodando e acess√≠vel na porta `9000`.
  * Um cliente local ser√° iniciado e entrar√° na fila de matchmaking automaticamente.

### Passo 2: Encontrar o IP da M√°quina Principal

Voc√™ precisar√° do endere√ßo de IP da m√°quina do servidor na rede local.

  * **No Linux/macOS:** `hostname -I`
  * **No Windows:** `ipconfig`

Procure por um endere√ßo como `172.16.201.14`.

### Passo 3: Iniciar o Cliente na M√°quina Secund√°ria

Nesta m√°quina, n√£o usaremos o `docker-compose.yml`. Em vez disso, rodaremos um cont√™iner do cliente manualmente, apontando para o IP do servidor.

1.  **Construa a imagem do cliente (apenas uma vez):**

    ```bash
    # No terminal da M√°quina Secund√°ria (172.16.201.15)
    docker build -t pingpong-client:latest -f client/Dockerfile .
    ```

2.  **Inicie o cliente conectado ao servidor:**
    Substitua `<IP_DA_MAQUINA_PRINCIPAL>` pelo endere√ßo de IP que voc√™ encontrou no passo 2.

    ```bash
    # No terminal da M√°quina Secund√°ria (172.16.201.15)
    docker run -it --rm --env SERVER_ADDR="<IP_DA_MAQUINA_PRINCIPAL>:9000" pingpong-client:latest
    ```

    Assim que este comando for executado, o cliente se conectar√° ao servidor, encontrar√° o outro cliente que j√° estava na fila, e a partida come√ßar√°\!

### Passo 4: Controlar os Dois Jogadores

Agora voc√™ precisa de um terminal para cada jogador.

1.  **Jogador 1 (M√°quina Secund√°ria):** O terminal onde voc√™ executou `docker run` j√° est√° controlando este jogador.
2.  **Jogador 2 (M√°quina Principal):** Abra um novo terminal na m√°quina principal e use `docker attach` para se conectar ao cliente que foi iniciado pelo Docker Compose.
    ```bash
    # Primeiro, encontre o nome do cont√™iner
    docker ps

    # Depois, conecte-se a ele (o nome pode variar)
    docker attach pbl2-redes-main-client-1
    ```

Agora voc√™ pode jogar uma carta em cada terminal e ver√° a partida progredir.

### Solu√ß√£o de Problemas de Conex√£o

Se o cliente na m√°quina secund√°ria n√£o conseguir se conectar, o problema √© quase sempre um **firewall** na m√°quina principal bloqueando a porta `9000`. Certifique-se de que o firewall do seu sistema operacional (Windows Defender, UFW no Linux, etc.) permite conex√µes de entrada na porta TCP `9000`.


## Comandos √öteis

- **Visualizar os logs de todos os servi√ßos em tempo real:**
  ```bash
  docker compose logs -f
  ```

- **Visualizar apenas os logs do servidor (monitorar PING/PONG e conex√µes):**
  ```bash
  docker attach pbl_server
  ```

- **Derrubar o ambiente** (para e remove os cont√™ineres):
  ```bash
  docker compose down -v
  ```

## Testes e Valida√ß√£o

O projeto inclui uma su√≠te completa de testes para validar a funcionalidade e robustez do sistema:

### Testes de Stress - Sistema de Pacotes

Para testar a concorr√™ncia e justi√ßa do sistema de pacotes:

```bash
cd tests
go run stress_packs.go
```

**Resultado esperado:**
- 20 clientes simult√¢neos disputando 10 pacotes
- Exatamente 10 sucessos e 10 falhas (`OUT_OF_STOCK`)
- Estoque final = 0
- Nenhuma carta duplicada no mesmo pacote
- Log de auditoria completo

### Testes Unit√°rios

Execute os testes automatizados com:

```bash
cd tests
go test -v
```

**Testes inclu√≠dos:**
- `TestPackStoreConcurrency`: Valida√ß√£o de concorr√™ncia thread-safe
- `TestPackStoreBasicFunctionality`: Testes de funcionalidade b√°sica
- `BenchmarkPackStoreConcurrency`: Benchmark de performance

### Exemplo de Resultado dos Testes:
```
=== TESTE DE STRESS ===
‚úÖ Sucessos: 10
‚ùå Falhas: 10
üì¶ Estoque final: 0
üéâ TESTE PASSOU: Todos os crit√©rios foram atendidos!

=== TESTES UNIT√ÅRIOS ===
--- PASS: TestPackStoreConcurrency (0.00s)
--- PASS: TestPackStoreBasicFunctionality (0.00s)
```

## Vari√°veis de Ambiente

√â poss√≠vel customizar a execu√ß√£o atrav√©s de vari√°veis de ambiente no arquivo `docker-compose.yml`.

- `SERVER_ADDR` (cliente): Endere√ßo do servidor ao qual o cliente deve se conectar. Ex: `server:9000`.
- `PING_INTERVAL_MS` (cliente): Intervalo em milissegundos para o envio de PINGs para medi√ß√£o de lat√™ncia. Padr√£o: `2000` (2 segundos).
- `LISTEN_ADDR` (servidor): Endere√ßo e porta em que o servidor escutar√° por conex√µes. Ex: `:9000`.

## Arquitetura da Aplica√ß√£o

### Estrutura do Projeto:
```
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îú‚îÄ‚îÄ main.go              # Servidor principal com handlers
‚îÇ   ‚îú‚îÄ‚îÄ cards.json           # Base de dados de cartas
‚îÇ   ‚îú‚îÄ‚îÄ packs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ packs.go         # Sistema de pacotes thread-safe
‚îÇ   ‚îú‚îÄ‚îÄ game/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cards.go         # L√≥gica de cartas e sistema de pacotes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ match.go         # L√≥gica de partidas e duelos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.go         # Tipos e constantes do jogo
‚îÇ   ‚îî‚îÄ‚îÄ protocol/
‚îÇ       ‚îî‚îÄ‚îÄ protocol.go      # Protocolo de comunica√ß√£o JSONL
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îî‚îÄ‚îÄ main.go              # Cliente com interface de comandos
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ stress_packs.go      # Teste de stress do sistema de pacotes
‚îÇ   ‚îî‚îÄ‚îÄ packs_test.go        # Testes unit√°rios e benchmarks
‚îî‚îÄ‚îÄ docker-compose.yml       # Orquestra√ß√£o dos cont√™ineres
```

### Fluxo de Comunica√ß√£o:

1. **Inicializa√ß√£o**: Cliente conecta ao servidor via TCP e entra na fila de matchmaking
2. **Matchmaking**: Servidor pareia jogadores em duelos 1v1 autom√°ticos
3. **Duelos**: Sistema de turnos simult√¢neos com cartas, elementos e c√°lculo de dano
4. **Pacotes**: Sistema de abertura de pacotes com estoque global e controle de concorr√™ncia
5. **Monitoramento**: Sistema PING/PONG para medi√ß√£o de lat√™ncia em tempo real

### Protocolo de Mensagens (JSONL):

**Cliente ‚Üí Servidor:**
- `{"t": "FIND_MATCH"}`: Entra na fila de matchmaking
- `{"t": "PLAY", "cardId": "c_001"}`: Joga uma carta espec√≠fica
- `{"t": "OPEN_PACK"}`: Solicita abertura de pacote
- `{"t": "PING", "ts": 1234567890}`: Ping para medi√ß√£o de lat√™ncia
- `{"t": "CHAT", "text": "mensagem"}`: Mensagem de chat
- `{"t": "LEAVE"}`: Sair da partida/desconectar

**Servidor ‚Üí Cliente:**
- `{"t": "MATCH_FOUND", "matchId": "m_001", "opponentId": "p_b"}`: Partida encontrada
- `{"t": "STATE", "you": {...}, "opponent": {...}, "round": 1}`: Estado da partida
- `{"t": "ROUND_RESULT", "you": {...}, "opponent": {...}}`: Resultado da rodada
- `{"t": "PACK_OPENED", "cards": ["c_1", "c_2"], "stock": 99}`: Pacote aberto
- `{"t": "ERROR", "code": "OUT_OF_STOCK", "msg": "..."}`: Mensagem de erro
- `{"t": "PONG", "ts": 1234567890, "rttMs": 42}`: Resposta de ping

### Comandos do Cliente:

- `/help`: Mostra a lista completa de comandos dispon√≠veis
- `/play <√≠ndice>`: Joga uma carta pelo √≠ndice (1-5) durante uma partida
- `/hand`: Exibe as cartas na m√£o atual do jogador
- `/pack`: Abre um pacote de cartas (consome do estoque global)
- `/ping`: Liga/desliga a exibi√ß√£o de RTT (lat√™ncia) no console
- `/quit`: Sai do jogo e desconecta do servidor