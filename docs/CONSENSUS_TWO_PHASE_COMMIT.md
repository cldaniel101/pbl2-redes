# Sistema de Consenso Two-Phase Commit - Implementa√ß√£o Completa

## üìã Vis√£o Geral

Este documento descreve a implementa√ß√£o completa do sistema de consenso baseado em **Two-Phase Commit com ACKs** para o jogo de cartas multiplayer distribu√≠do. O sistema foi projetado para resolver o problema de deadlock no `resolveRound()` e garantir consist√™ncia de estado entre servidores.

## ‚úÖ Status da Implementa√ß√£o

**CONCLU√çDO** - Todas as funcionalidades do item 2 foram implementadas com sucesso.

## üéØ Objetivos Alcan√ßados

1. ‚úÖ Implementar Fase 1: Proposta e ACKs
2. ‚úÖ Implementar Fase 2: Verifica√ß√£o e Execu√ß√£o
3. ‚úÖ Integrar com `PlayCard()` para usar Two-Phase Commit automaticamente
4. ‚úÖ Criar endpoints S2S para comunica√ß√£o de consenso
5. ‚úÖ Implementar valida√ß√£o de opera√ß√µes
6. ‚úÖ Implementar mecanismos de rollback

## üèóÔ∏è Arquitetura

### Fluxo Completo do Two-Phase Commit

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FASE 1: PROPOSTA E ACKs                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Server-1 (Proposer)                Server-2                Server-3
      ‚îÇ                                 ‚îÇ                       ‚îÇ
      ‚îÇ 1. Jogador faz jogada           ‚îÇ                       ‚îÇ
      ‚îÇ CreatePlayOperation()           ‚îÇ                       ‚îÇ
      ‚îÇ (Incrementa VectorClock)        ‚îÇ                       ‚îÇ
      ‚îÇ                                 ‚îÇ                       ‚îÇ
      ‚îÇ 2. Prop√µe opera√ß√£o              ‚îÇ                       ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/propose‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/propose‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ 3. Valida  ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ Opera√ß√£o   ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                          4. Envia ACK        ‚îÇ          ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/ack‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§          ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/ack‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ 5. waitForACKs()                ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ (timeout: 5s)                   ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   FASE 2: VERIFICA√á√ÉO E EXECU√á√ÉO                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

      ‚îÇ 6. Todos ACKs recebidos         ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ 7. Verifica validade cross-server            ‚îÇ          ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/check‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ           ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/check‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ200 OK (v√°lido)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§            ‚îÇ          ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ200 OK (v√°lido)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ 8. ExecuteOperation()           ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ (local)                         ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ 9. Solicita commit              ‚îÇ            ‚îÇ          ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/commit‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ          ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/commit‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ ExecuteOperation()    ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            ExecuteOperation()
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚úì Opera√ß√£o executada em todos os servidores   ‚îÇ          ‚îÇ
```

### Fluxo de Rollback (Caso de Falha)

```
Server-1 (Proposer)                Server-2                Server-3
      ‚îÇ                                 ‚îÇ                       ‚îÇ
      ‚îÇ Timeout ou Opera√ß√£o Inv√°lida    ‚îÇ                       ‚îÇ
      ‚îÇ                                 ‚îÇ                       ‚îÇ
      ‚îÇ RollbackOperation()             ‚îÇ                       ‚îÇ
      ‚îÇ (local)                         ‚îÇ                       ‚îÇ
      ‚îÇ                                 ‚îÇ                       ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/rollback‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ          ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄPOST /api/matches/{id}/rollback‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ RollbackOperation()   ‚îÇ
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚îÇ                                 ‚îÇ            RollbackOperation()
      ‚îÇ                                 ‚îÇ            ‚îÇ          ‚îÇ
      ‚úó Opera√ß√£o descartada em todos os servidores  ‚îÇ          ‚îÇ
```

## üìù Componentes Implementados

### 1. M√©todos no Match (`server/game/match.go`)

#### `proposeOperation(op, otherServers) (ackChan, errChan)`
Prop√µe uma opera√ß√£o para outros servidores (Fase 1).

```go
// Adiciona opera√ß√£o na fila local
// Registra como pendente de ACKs
// Envia proposta para outros servidores via S2S
// Aguarda ACKs com timeout de 5 segundos
```

**Entrada**: Opera√ß√£o e lista de servidores  
**Sa√≠da**: Canais para notifica√ß√£o de ACKs ou erro

#### `waitForACKs(operationID, timeout) bool`
Aguarda confirma√ß√µes de todos os servidores com timeout.

```go
// Verifica periodicamente (ticker de 100ms)
// Retorna true se todos confirmaram
// Retorna false se timeout expirou
```

**Entrada**: ID da opera√ß√£o e timeout  
**Sa√≠da**: `true` se todos ACKs recebidos, `false` se timeout

#### `CheckOperationValidity(op) (bool, error)`
Verifica se uma opera√ß√£o √© v√°lida no estado atual.

```go
// Para OpTypePlay:
//   - Verifica se jogador est√° na partida
//   - Verifica estado da partida (StateAwaitingPlays)
//   - Verifica se jogador j√° jogou
//   - Valida carta no CardDB
//   - Verifica se carta est√° na m√£o do jogador
```

**Entrada**: Opera√ß√£o a validar  
**Sa√≠da**: `(true, nil)` se v√°lida, `(false, error)` se inv√°lida

#### `ExecuteOperation(op) error`
Executa uma opera√ß√£o ap√≥s consenso (Fase 2).

```go
// Atualiza rel√≥gio vetorial com timestamp da opera√ß√£o
// Executa a√ß√£o espec√≠fica do tipo de opera√ß√£o
// Remove opera√ß√£o da fila
// Verifica se ambos jogaram para resolver rodada
```

**Entrada**: Opera√ß√£o a executar  
**Sa√≠da**: `nil` se sucesso, `error` se falha

#### `RollbackOperation(op)`
Descarta uma opera√ß√£o inv√°lida.

```go
// Remove opera√ß√£o da fila
// Remove dos ACKs pendentes
// Notifica jogador sobre rejei√ß√£o
```

**Entrada**: Opera√ß√£o a reverter  
**Sa√≠da**: Nenhuma

#### `playCardWithConsensus(playerID, cardID) error`
Implementa Two-Phase Commit para jogadas em partidas distribu√≠das.

```go
// Fase 1:
//   - Cria opera√ß√£o com CreatePlayOperation()
//   - Prop√µe para outros servidores
//   - Aguarda ACKs
//
// Fase 2:
//   - Verifica validade cross-server com CheckOperation()
//   - Se v√°lido: ExecuteOperation() + CommitOperation()
//   - Se inv√°lido: RollbackOperation()
```

**Entrada**: ID do jogador e ID da carta  
**Sa√≠da**: `nil` se sucesso, `error` se falha

### 2. Fun√ß√µes S2S (`server/s2s/client.go`)

#### `ProposeOperation(remoteServer, matchID, op) error`
Envia uma proposta de opera√ß√£o para outro servidor (Fase 1).

**Endpoint**: `POST /api/matches/{matchID}/propose`  
**Timeout**: 5 segundos

#### `SendACK(remoteServer, matchID, operationID, senderServerID) error`
Envia um ACK de uma opera√ß√£o para outro servidor.

**Endpoint**: `POST /api/matches/{matchID}/ack`  
**Timeout**: 5 segundos

#### `CheckOperation(remoteServer, matchID, op) (bool, error)`
Solicita verifica√ß√£o de validade de uma opera√ß√£o (Fase 2).

**Endpoint**: `POST /api/matches/{matchID}/check`  
**Timeout**: 5 segundos  
**Retorno**: 
- `200 OK` ‚Üí opera√ß√£o v√°lida
- `409 Conflict` ‚Üí opera√ß√£o inv√°lida

#### `CommitOperation(remoteServer, matchID, op) error`
Solicita execu√ß√£o de uma opera√ß√£o ap√≥s consenso (Fase 2).

**Endpoint**: `POST /api/matches/{matchID}/commit`  
**Timeout**: 5 segundos

#### `RollbackOperation(remoteServer, matchID, op) error`
Solicita rollback de uma opera√ß√£o (Fase 2).

**Endpoint**: `POST /api/matches/{matchID}/rollback`  
**Timeout**: 5 segundos

### 3. Endpoints da API (`server/api/handlers.go`)

#### `POST /api/matches/{matchID}/propose`
Recebe uma proposta de opera√ß√£o de outro servidor.

**Handler**: `handlePropose(w, r, matchID)`

```go
1. Decodifica opera√ß√£o do JSON
2. Encontra partida no StateManager
3. Atualiza rel√≥gio vetorial local
4. Adiciona opera√ß√£o √† fila
5. Valida opera√ß√£o com CheckOperationValidity()
6. Envia ACK de volta ao proposer
```

**Status de Resposta**:
- `200 OK` ‚Üí opera√ß√£o v√°lida e ACK enviado
- `409 Conflict` ‚Üí opera√ß√£o inv√°lida
- `404 Not Found` ‚Üí partida n√£o encontrada

#### `POST /api/matches/{matchID}/ack`
Recebe um ACK de outro servidor.

**Handler**: `handleACK(w, r, matchID)`

```go
1. Decodifica ACK do JSON
2. Encontra partida no StateManager
3. Marca ACK com match.MarkACK()
4. Verifica se todos ACKs foram recebidos
```

**Status de Resposta**:
- `200 OK` ‚Üí ACK registrado
- `404 Not Found` ‚Üí partida n√£o encontrada

#### `POST /api/matches/{matchID}/check`
Verifica se uma opera√ß√£o √© v√°lida (Fase 2).

**Handler**: `handleCheck(w, r, matchID)`

```go
1. Decodifica opera√ß√£o do JSON
2. Encontra partida no StateManager
3. Valida opera√ß√£o com CheckOperationValidity()
```

**Status de Resposta**:
- `200 OK` ‚Üí opera√ß√£o v√°lida
- `409 Conflict` ‚Üí opera√ß√£o inv√°lida
- `404 Not Found` ‚Üí partida n√£o encontrada

#### `POST /api/matches/{matchID}/commit`
Executa uma opera√ß√£o ap√≥s consenso (Fase 2).

**Handler**: `handleCommit(w, r, matchID)`

```go
1. Decodifica opera√ß√£o do JSON
2. Encontra partida no StateManager
3. Executa opera√ß√£o com match.ExecuteOperation()
```

**Status de Resposta**:
- `200 OK` ‚Üí opera√ß√£o executada
- `500 Internal Server Error` ‚Üí erro na execu√ß√£o
- `404 Not Found` ‚Üí partida n√£o encontrada

#### `POST /api/matches/{matchID}/rollback`
Reverte uma opera√ß√£o (Fase 2).

**Handler**: `handleRollback(w, r, matchID)`

```go
1. Decodifica opera√ß√£o do JSON
2. Encontra partida no StateManager
3. Reverte opera√ß√£o com match.RollbackOperation()
```

**Status de Resposta**:
- `200 OK` ‚Üí rollback executado
- `404 Not Found` ‚Üí partida n√£o encontrada

## üîÑ Integra√ß√£o com PlayCard()

O m√©todo `PlayCard()` foi modificado para detectar automaticamente se √© uma partida distribu√≠da e usar o sistema de consenso:

```go
func (m *Match) PlayCard(playerID, cardID string) error {
    // Valida√ß√µes iniciais...
    
    // Verifica se √© uma partida distribu√≠da
    if m.VectorClock != nil {
        // Usa Two-Phase Commit
        return m.playCardWithConsensus(playerID, cardID)
    }
    
    // Partida local - usa l√≥gica simples
    m.Waiting[playerID] = cardID
    if len(m.Waiting) == 2 {
        go m.resolveRound()
    }
    return nil
}
```

**Diferen√ßas entre Partidas Locais e Distribu√≠das**:

| Aspecto | Partida Local | Partida Distribu√≠da |
|---------|--------------|---------------------|
| Sincroniza√ß√£o | Lock local simples | Two-Phase Commit |
| Valida√ß√£o | Local apenas | Cross-server |
| Timestamp | `time.Now()` | Rel√≥gio Vetorial |
| Rollback | N√£o necess√°rio | Implementado |
| Timeout | N√£o aplic√°vel | 5 segundos |

## üõ°Ô∏è Mecanismos de Toler√¢ncia a Falhas

### 1. Timeout de ACKs
- **Dura√ß√£o**: 5 segundos
- **A√ß√£o**: Rollback autom√°tico se timeout expirar
- **Logs**: Registra opera√ß√£o e servidores que n√£o responderam

### 2. Valida√ß√£o Cross-Server
- Verifica estado em todos os servidores antes de executar
- Se um servidor rejeitar, todos fazem rollback
- Garante consist√™ncia global

### 3. Rollback Coordenado
- Proposer inicia rollback local
- Notifica todos os outros servidores
- Cada servidor remove opera√ß√£o da fila
- Notifica jogadores sobre rejei√ß√£o

### 4. Rel√≥gio Vetorial
- Garante ordena√ß√£o causal de opera√ß√µes
- Resolve conflitos de opera√ß√µes concorrentes
- Mant√©m consist√™ncia de estado

## üìä Logs e Debugging

O sistema gera logs detalhados para debugging:

```
[MATCH match-123] Iniciando consenso para opera√ß√£o op-1234 com servidores: [http://server-2:8000]
[MATCH match-123] Propondo opera√ß√£o op-1234 para [http://server-2:8000]
[S2S] Propondo opera√ß√£o op-1234 para http://server-2:8000/api/matches/match-123/propose
[API] Proposta recebida para partida match-123: opera√ß√£o op-1234
[API] ACK recebido para partida match-123: opera√ß√£o op-1234 do servidor server-2
[MATCH match-123] Todos os ACKs recebidos para opera√ß√£o op-1234
[S2S] Verificando opera√ß√£o op-1234 em http://server-2:8000
[S2S] Opera√ß√£o op-1234 √© v√°lida em http://server-2:8000
[MATCH match-123] Executando opera√ß√£o op-1234 (tipo: PLAY)
[MATCH match-123] Jogada registrada: player-1 jogou card-fire-dragon
[S2S] Comitando opera√ß√£o op-1234 em http://server-2:8000
[MATCH match-123] Opera√ß√£o op-1234 executada com sucesso via consenso
```

### Logs de Rollback

```
[MATCH match-123] Timeout aguardando ACKs para opera√ß√£o op-1234
[MATCH match-123] Erro no consenso para opera√ß√£o op-1234: timeout aguardando ACKs
[MATCH match-123] Revertendo opera√ß√£o op-1234 (tipo: PLAY)
[S2S] Solicitando rollback da opera√ß√£o op-1234 em http://server-2:8000
```

## üéØ Vantagens do Sistema Implementado

### ‚úÖ Consist√™ncia Forte
- Garante que todos os servidores executem opera√ß√µes na mesma ordem
- Usa rel√≥gios vetoriais para ordena√ß√£o causal
- Valida√ß√£o cross-server previne estados inconsistentes

### ‚úÖ Sem Deadlocks
- N√£o mant√©m locks durante chamadas HTTP
- Opera√ß√µes ass√≠ncronas com canais
- Timeout garante que sistema n√£o trave indefinidamente

### ‚úÖ Tolerante a Falhas
- Rollback autom√°tico em caso de falha
- Timeout de 5 segundos previne espera infinita
- Logs detalhados facilitam debugging

### ‚úÖ Transparente para o C√≥digo Existente
- `PlayCard()` detecta automaticamente se √© distribu√≠da
- C√≥digo de partidas locais n√£o foi modificado
- Integra√ß√£o seamless com sistema existente

### ‚úÖ Escal√°vel
- Suporta m√∫ltiplos servidores
- Opera√ß√µes concorrentes s√£o ordenadas corretamente
- Fila de opera√ß√µes permite processamento ass√≠ncrono

## üß™ Como Testar

### Teste Manual

1. **Iniciar 3 servidores**:
```bash
docker-compose up
```

2. **Conectar dois clientes em servidores diferentes**:
```bash
# Cliente 1 ‚Üí Server-1
go run client/main.go localhost:7000

# Cliente 2 ‚Üí Server-2
go run client/main.go localhost:7001
```

3. **Iniciar matchmaking e jogar**:
```
> match
> 1    # Joga primeira carta
```

4. **Observar logs**:
- Verificar propaga√ß√£o de opera√ß√µes
- Confirmar recebimento de ACKs
- Validar execu√ß√£o coordenada

### Teste de Falha

1. **Simular timeout**: Desconectar um servidor durante proposta
2. **Verificar rollback**: Confirmar que opera√ß√£o foi descartada
3. **Verificar logs**: Mensagens de timeout e rollback

### Teste de Concorr√™ncia

1. **Ambos jogadores jogam simultaneamente**
2. **Verificar ordena√ß√£o**: Rel√≥gio vetorial deve resolver ordem
3. **Confirmar consist√™ncia**: Ambos servidores devem ter mesma ordem

## üìö Refer√™ncias

- [Two-Phase Commit Protocol](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)
- [Vector Clocks](https://en.wikipedia.org/wiki/Vector_clock)
- [CONSENSUS_STRUCTURES.md](./CONSENSUS_STRUCTURES.md) - Estruturas de dados base
- [F0 - arquitetura_distribuida.md](./F0%20-%20arquitetura_distribuida.md) - Arquitetura DistriBank

## üéâ Conclus√£o

O sistema de consenso Two-Phase Commit foi **implementado com sucesso** e est√° pronto para uso. Todos os objetivos foram alcan√ßados:

- ‚úÖ Fase 1 (Proposta e ACKs) implementada
- ‚úÖ Fase 2 (Verifica√ß√£o e Execu√ß√£o) implementada
- ‚úÖ Integra√ß√£o com `PlayCard()` conclu√≠da
- ‚úÖ Endpoints S2S funcionais
- ‚úÖ Valida√ß√£o e rollback implementados
- ‚úÖ Sistema tolerante a falhas

O sistema resolve o problema de deadlock original e garante consist√™ncia de estado entre servidores distribu√≠dos usando rel√≥gios vetoriais e Two-Phase Commit com ACKs.

---

**Data**: 22 de outubro de 2025  
**Status**: ‚úÖ IMPLEMENTA√á√ÉO COMPLETA

